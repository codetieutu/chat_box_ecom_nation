<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Add Stock from File</h1>
            <a href="/products" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Products
            </a>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- Product Info -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-box me-2"></i>Product Information
                </h5>
                <div class="row">
                    <div class="col-md-3">
                        <strong>ID:</strong><br>
                        <span class="fw-bold text-primary">#<%= product.id %></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Name:</strong><br>
                        <span class="fw-bold">
                            <%= product.name %>
                        </span>
                        <% if (variant && variant.name) { %>
                            <div class="mt-1">
                                <strong>Variant:</strong><br>
                                <span class="badge bg-info fs-6">
                                    <%= variant.name %>
                                </span>
                            </div>
                            <% } %>
                    </div>
                    <div class="col-md-3">
                        <strong>Current Stock:</strong><br>
                        <span class="badge bg-success fs-6">
                            <% if (variant && variant.stock !==undefined) { %>
                                <%= variant.stock %> units
                                    <% } else { %>
                                        <%= product.stock %> units
                                            <% } %>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Variants Info -->
        <% if (product.variants && product.variants.length> 0) { %>
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-list me-2"></i>Product Variants
                    </h5>
                    <div class="row">
                        <% product.variants.forEach(variantItem=> { %>
                            <div class="col-md-4 mb-3">
                                <div class="card variant-card <%= variant && variant.id === variantItem.id ? 'border-primary' : '' %>"
                                    style="<%= variant && variant.id === variantItem.id ? 'border-width: 2px;' : '' %>">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">
                                            <%= variantItem.name %>
                                                <% if (variant && variant.id===variantItem.id) { %>
                                                    <span class="badge bg-primary">Selected</span>
                                                    <% } %>
                                        </h6>
                                        <div class="price text-primary fw-bold">
                                            <%= variantItem.price.toLocaleString() %> VND
                                        </div>
                                        <div class="stock-info">
                                            <span
                                                class="badge <%= variantItem.stock > 0 ? 'bg-success' : 'bg-warning' %>">
                                                <%= variantItem.stock %> in stock
                                            </span>
                                        </div>
                                        <div class="status mt-2">
                                            <small class="text-muted">
                                                Status:
                                                <span
                                                    class="badge <%= variantItem.status === 'A' ? 'bg-success' : 'bg-secondary' %>">
                                                    <%= variantItem.status==='A' ? 'Active' : 'Inactive' %>
                                                </span>
                                            </small>
                                        </div>
                                        <% if (!variant || variant.id !==variantItem.id) { %>
                                            <div class="mt-2">
                                                <a href="/products/stock-upload/<%= product.id %>?variant=<%= variantItem.id %>"
                                                    class="btn btn-sm btn-outline-primary">
                                                    Select this variant
                                                </a>
                                            </div>
                                            <% } %>
                                    </div>
                                </div>
                            </div>
                            <% }); %>
                    </div>
                </div>
            </div>
            <% } %>

                <!-- Selected Variant Info -->
                <% if (variant) { %>
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title text-success">
                                <i class="fas fa-check-circle me-2"></i>Selected Variant
                            </h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <strong>Variant Name:</strong><br>
                                    <span class="fw-bold text-primary">
                                        <%= variant.variant_name %>
                                    </span>
                                </div>
                                <div class="col-md-4">
                                    <strong>Price:</strong><br>
                                    <span class="fw-bold">
                                        <%= variant.price.toLocaleString() %> VND
                                    </span>
                                </div>
                                <div class="col-md-4">
                                    <strong>Current Stock:</strong><br>
                                    <span class="badge bg-success fs-6">
                                        <%= variant.stock %> units
                                    </span>
                                </div>
                            </div>
                            <!-- <div class="mt-2">
                                <a href="/products/stock-upload/<%= product.id %>"
                                    class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i>Clear selection
                                </a>
                            </div> -->
                        </div>
                    </div>
                    <% } else if (product.variants && product.variants.length> 0) { %>
                        <!-- Variant Selection -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-tag me-2"></i>Select Variant
                                </h5>
                                <div class="mb-3">
                                    <label for="variantSelect" class="form-label fw-bold">Choose variant to add
                                        stock</label>
                                    <select class="form-control" id="variantSelect" name="variant_id">
                                        <option value="">Select a variant</option>
                                        <% product.variants.forEach(variantItem=> { %>
                                            <option value="<%= variantItem.id %>" data-stock="<%= variantItem.stock %>"
                                                data-name="<%= variantItem.name %>"
                                                <%=selectedVariantId===variantItem.id ? 'selected' : '' %>>
                                                <%= variantItem.name %> - <%= variantItem.price.toLocaleString() %> VND
                                                        (Current: <%= variantItem.stock %>)
                                            </option>
                                            <% }); %>
                                    </select>
                                </div>
                                <div id="selectedVariantInfo" class="alert alert-info" style="display: none;">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Selected:</strong> <span id="selectedVariantName"></span> |
                                    <strong>Current Stock:</strong> <span id="selectedVariantStock"
                                        class="badge bg-success"></span>
                                </div>
                            </div>
                        </div>
                        <% } %>

                            <!-- Upload Area -->
                            <div class="card">
                                <div class="card-body">
                                    <form action="/products/stock-upload/<%= variant.id %>" method="POST"
                                        id="uploadForm">
                                        <% if ((product.variants && product.variants.length> 0) && !variant) { %>
                                            <input type="hidden" id="selectedVariantId" name="variant_id" value="">
                                            <% } %>
                                                <% if (variant) { %>
                                                    <input type="hidden" name="variant_id" value="<%= variant.id %>">
                                                    <% } %>

                                                        <!-- File Upload Section -->
                                                        <div class="mb-4">
                                                            <label class="form-label fw-bold">
                                                                <i class="fas fa-file-upload me-2"></i>Upload TXT File
                                                            </label>
                                                            <div class="file-upload-area border rounded p-4 text-center"
                                                                id="fileUploadArea"
                                                                style="background-color: #f8f9fa; border-style: dashed !important;">
                                                                <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                                                                <h5>Drop your TXT file here or click to browse</h5>
                                                                <p class="text-muted mb-3">Supports .txt files with one
                                                                    item per line</p>
                                                                <input type="file" id="fileInput" accept=".txt"
                                                                    class="d-none">
                                                                <button type="button" class="btn btn-primary"
                                                                    onclick="document.getElementById('fileInput').click()">
                                                                    <i class="fas fa-folder-open me-2"></i>Choose File
                                                                </button>
                                                                <div id="fileInfo" class="mt-3" style="display: none;">
                                                                    <span id="fileName" class="fw-bold"></span>
                                                                    <span id="fileSize" class="text-muted ms-2"></span>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Text Area for Data -->
                                                        <div class="mb-4">
                                                            <label for="stockData" class="form-label fw-bold">
                                                                <i class="fas fa-edit me-2"></i>Stock Data
                                                            </label>
                                                            <textarea class="form-control" id="stockData"
                                                                name="stockData" rows="12"
                                                                placeholder="Enter stock data here (one item per line)&#10;Or upload a TXT file to automatically populate this area"
                                                                style="font-family: 'Courier New', monospace; font-size: 14px;"></textarea>
                                                            <div class="form-text">
                                                                <i class="fas fa-info-circle me-1"></i>
                                                                Enter one item per line. Each line will be counted as
                                                                one stock unit.
                                                            </div>
                                                        </div>

                                                        <!-- Preview Section -->
                                                        <div class="mb-4" id="previewSection" style="display: none;">
                                                            <label class="form-label fw-bold">
                                                                <i class="fas fa-eye me-2"></i>Preview
                                                            </label>
                                                            <div class="card">
                                                                <div class="card-body">
                                                                    <div id="previewContent"></div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Statistics -->
                                                        <div class="row mb-4">
                                                            <div class="col-md-3">
                                                                <div class="card bg-light">
                                                                    <div class="card-body text-center">
                                                                        <h4 id="lineCount" class="text-primary mb-1">0
                                                                        </h4>
                                                                        <small class="text-muted">Total Lines</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <div class="card bg-light">
                                                                    <div class="card-body text-center">
                                                                        <h4 id="validCount" class="text-success mb-1">0
                                                                        </h4>
                                                                        <small class="text-muted">Valid Items</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <div class="card bg-light">
                                                                    <div class="card-body text-center">
                                                                        <h4 id="newStock" class="text-info mb-1">
                                                                            <% if (variant) { %>
                                                                                <%= variant.stock %>
                                                                                    <% } else { %>
                                                                                        <%= product.stock %>
                                                                                            <% } %>
                                                                        </h4>
                                                                        <small class="text-muted">New Total
                                                                            Stock</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <div class="card bg-light">
                                                                    <div class="card-body text-center">
                                                                        <h4 id="addedCount" class="text-warning mb-1">0
                                                                        </h4>
                                                                        <small class="text-muted">Items to Add</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Action Buttons -->
                                                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                                            <button type="button"
                                                                class="btn btn-outline-secondary me-md-2"
                                                                onclick="clearData()">
                                                                <i class="fas fa-eraser me-2"></i>Clear Data
                                                            </button>
                                                            <button type="submit" class="btn btn-success"
                                                                id="submitBtn">
                                                                <i class="fas fa-save me-2"></i>Add to Stock
                                                            </button>
                                                        </div>
                                    </form>
                                </div>
                            </div>
    </div>
</div>

<script>
    // File upload functionality
    const fileInput = document.getElementById('fileInput');
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const stockData = document.getElementById('stockData');
    const previewSection = document.getElementById('previewSection');
    const previewContent = document.getElementById('previewContent');

    // Drag and drop events
    fileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadArea.style.backgroundColor = '#e9ecef';
        fileUploadArea.style.borderColor = '#007bff';
    });

    fileUploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        fileUploadArea.style.backgroundColor = '#f8f9fa';
        fileUploadArea.style.borderColor = '#dee2e6';
    });

    fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.style.backgroundColor = '#f8f9fa';
        fileUploadArea.style.borderColor = '#dee2e6';

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });

    // File input change event
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFile(e.target.files[0]);
        }
    });

    // Handle file processing
    function handleFile(file) {
        if (file.type !== 'text/plain' && !file.name.endsWith('.txt')) {
            alert('Please select a TXT file.');
            return;
        }

        // Update file info
        fileName.textContent = file.name;
        fileSize.textContent = `(${(file.size / 1024).toFixed(2)} KB)`;
        fileInfo.style.display = 'block';

        // Read file content
        const reader = new FileReader();
        reader.onload = function (e) {
            const content = e.target.result;
            stockData.value = content;
            updatePreview();
            updateStatistics();
        };
        reader.readAsText(file);
    }

    // Update preview based on textarea content
    stockData.addEventListener('input', function () {
        updatePreview();
        updateStatistics();
    });

    function updatePreview() {
        const content = stockData.value.trim();
        if (content) {
            const lines = content.split('\n').filter(line => line.trim());
            previewContent.innerHTML = lines.map(line =>
                `<div class="border-bottom pb-1 mb-1">${line.trim()}</div>`
            ).join('');
            previewSection.style.display = 'block';
        } else {
            previewSection.style.display = 'none';
        }
    }

    function updateStatistics() {
        const content = stockData.value.trim();
        const lines = content ? content.split('\n').filter(line => line.trim()) : [];
        const validLines = lines.filter(line => line.trim().length > 0);

        document.getElementById('lineCount').textContent = lines.length;
        document.getElementById('validCount').textContent = validLines.length;
        document.getElementById('addedCount').textContent = validLines.length;
        document.getElementById('newStock').textContent = <%= product.stock %> + validLines.length;
    }

    function clearData() {
        stockData.value = '';
        fileInput.value = '';
        fileInfo.style.display = 'none';
        previewSection.style.display = 'none';
        updateStatistics();
    }

    // Initialize statistics
    updateStatistics();
</script>

<style>
    .file-upload-area {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .file-upload-area:hover {
        background-color: #e9ecef !important;
        border-color: #007bff !important;
    }

    .form-text {
        font-size: 0.875rem;
    }

    .card.bg-light {
        border: 1px solid #dee2e6;
    }

    .variant-card {
        transition: transform 0.2s ease;
        border: 1px solid #e9ecef;
    }

    .variant-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .variant-card .card-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #495057;
    }

    .variant-card .price {
        font-size: 1.1rem;
        margin: 0.5rem 0;
    }

    .border-primary {
        border-color: #007bff !important;
    }
</style>